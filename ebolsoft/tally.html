<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <!-- Meta, title, CSS, favicons, etc. -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>App</title>
    <link rel="icon" href="./img/app_icon.ico">

    <link href="./vendor/css/bootstrap.min.css" rel="stylesheet" />
    <!-- Custom Theme Style -->
    <link href="./build/css/custom.css" rel="stylesheet">
    <link rel="stylesheet" href="./vendor/css/bootstrap-select.min.css">
    <!-- Font Awesome -->
    <link href="./vendors/font-awesome/css/font-awesome.min.css" rel="stylesheet">
    <!-- NProgress -->
    <link href="./vendors/nprogress/nprogress.css" rel="stylesheet">

    <!-- iCheck -->
    <link href="./vendors/iCheck/skins/flat/green.css" rel="stylesheet">
    <!-- bootstrap-daterangepicker -->
    <link href="./css/datepicker.min.css" rel="stylesheet">

    <link rel="stylesheet" href="./dist/css/bootstrapValidator.css" />
    <link rel="stylesheet" href="./vendor/css/bootstrap-table.min.css" />
    <link href="./vendor/css/toastr.min.css" rel="stylesheet">

    <link href="./css/bootstrap-editable.css" rel="stylesheet" />
    

</head>
<style>

.panel {
  /* for text on pannel */
  margin-top: 27px !important;
}

.panel-body {
    background:#E5E4E2 none repeat scroll 0 0;
  padding-top: 2px !important;
}
.tallycard {
  border-radius: 15px;
  border: 2px solid #73AD21;
  padding: 2px;
  margin-top: 2px;
  margin-bottom: 2px;
}
    </style>
<body class="nav-md">
    <div class="container body">
        <div class="main_container">
            <div class="col-md-3 left_col">
                <div class="left_col scroll-view">
                    <div class="navbar nav_title" style="border: 0;">
                        <a href="index.html" class="site_title">
                            <img src="./img/company_icon.ico" />
                            <span>Quality One</span>
                        </a>
                    </div>

                    <div class="clearfix"></div>

                    <!-- menu profile quick info -->
                    <div class="profile clearfix">
                        <div class="profile_pic">
                            <img src="images/img.jpg" alt="..." class="img-circle profile_img">
                        </div>
                        <div class="profile_info">
                            <span>Welcome,</span>
                            <h2 class="user_fullname_disaplay">Active User</h2>
                        </div>
                    </div>
                    <!-- /menu profile quick info -->

                    <br />

                    <!-- sidebar menu -->
                    <div id="sidebar-menu" class="main_menu_side hidden-print main_menu">
                        <div class="menu_section">
                            <h3>General</h3>
                            <ul class="nav side-menu">
                                <li>
                                    <a>
                                        <i class="fa fa-home"></i> Home
                                        <span class="fa fa-chevron-down"></span>
                                    </a>
                                    <ul class="nav child_menu">
                                        <li>
                                            <a href="index.html">Dashboard</a>
                                        </li>
                                    </ul>
                                </li>                                
                                   
                            </ul>
                        </div>


                    </div>
                    <!-- /sidebar menu -->

                    <!-- /menu footer buttons -->
                    <div class="sidebar-footer hidden-small">
                        <a data-toggle="tooltip" data-placement="top" title="Settings">
                            <span class="glyphicon glyphicon-cog" aria-hidden="true"></span>
                        </a>
                        <a data-toggle="tooltip" data-placement="top" title="FullScreen">
                            <span class="glyphicon glyphicon-fullscreen" aria-hidden="true"></span>
                        </a>
                        <a data-toggle="tooltip" data-placement="top" title="Lock">
                            <span class="glyphicon glyphicon-eye-close" aria-hidden="true"></span>
                        </a>
                        <a data-toggle="tooltip" data-placement="top" title="Logout" href="javascript:authenticateUser()">
                            <span class="glyphicon glyphicon-off" aria-hidden="true"></span>
                        </a>
                    </div>
                    <!-- /menu footer buttons -->
                </div>
            </div>

            <!-- top navigation -->
            <div class="top_nav">
                    <div class="nav_menu">
                            <nav>
                              <div class="nav toggle" style=" line-height: 12px;padding: 5px 5px;">
                                <a id="menu_toggle">
                                  <i style="font-size:16px" class="fa fa-bars"></i>
                                </a>
                              </div>
                  
                              <ul class="nav navbar-nav navbar-left">
                                <li class="">
                                  <a style=" line-height: 12px;padding: 5px 5px ;margin-top:2px" href="javascript:;" class="user-profile dropdown-toggle" data-toggle="dropdown"
                                    aria-expanded="false">
                                    <span style="font-size: 15px;color:#73879C;font-weight:bold;"> Tally Detail</span>
                                  </a>
                  
                                </li>
                  
                              </ul>
                  
                              <ul class="nav navbar-nav navbar-right">
                                <li class="">
                                  <a style=" line-height: 12px;padding: 0px 0px;" href="javascript:;" class="user-profile dropdown-toggle" data-toggle="dropdown"
                                    aria-expanded="false">
                                    <img src="images/img.jpg" alt=""><span class="user_fullname_disaplay">Active User</span>
                                    <span class=" fa fa-angle-down"></span>
                                  </a>
                                  <ul class="dropdown-menu dropdown-usermenu pull-right">
                                    <li>
                                      <a href="javascript:;"> Profile</a>
                                    </li>
                                    <li>
                                            <a href="javascript:passwordChangeRequest()"> 
                                                    <i class="fa fa-lock pull-right"></i> Change Password</a>
                                                    
                                                </a>
                                    </li>
                                    <li>
                                      <a href="javascript:displayHelp();">Help</a>
                                    </li>
                                    <li>
                                      <a href="javascript:authenticateUser()">
                                        <i class="fa fa-sign-out pull-right"></i> Log Out</a>
                                    </li>
                                  </ul>
                                </li>
                  
                                <li role="presentation" class="dropdownx">
                                  <button type="button" class="btn btn-round btn-success btn-sm " onclick="loadShortCutOption(this)">
                                    <i class="fa fa-search-plus"></i> BL Processing</button>
                  
                                </li>
                              </ul>
                            </nav>
                          </div>
            </div>
            <!-- /top navigation -->

            <!-- page content -->

            <div class="right_col" role="main">
                <span class="tallycard col-md-12 h3"  >
                    <div class=" col-sm-6">
                      <strong >Vessel: </strong>                 
                        <span class=" text-primary" id=vessel_name></span>
                    </div>
                    <div class=" col-sm-6">
                      <strong >Tally Status: </strong>                 
                        <span class=" text-primary" id=tally_status></span>
                    </div>
                    <div class="cube-count  col-sm-6">
                      <strong >In Progress On: </strong>                 
                      <b>  <span style="color:brown" id=tally_start></span></b>
                    </div>
                    <div class="cube-count  col-sm-6">
                        <strong >Quantity Tallied: </strong>                 
                        <b>  <span style="color:brown" id=tally_quantity></span></b>
                      </div>
                      
                </span>
                <div class="">
                    
                   
                    <div id="toolbar">
                        
                        
                        <div class="form-inline" role="form">
                            
                          <div class="form-group">
                            <a class="create btn btn-lg btn-success" id="create-rec" href="javascript:">Add New</a>
                          </div>
                          
                          <div class="form-group">
                            <label class="h3 control-label col-md-3">Booking</label>
                          </div>
                          <div class="form-group">
                            <select id="booking" onchange="loadTallyTable()" class="input-lg load-select form-control" data-path="./app/booking/tally"></select>
                          </div>
                          <div class="form-group ">
                            <label class="h3" style="margin-left: 20px;" for="booking_container">Container</label>
                            <select class="input-lg load-select form-control" onchange="loadContainerStatus()"  id="booking_container" ></select>
                          </div>
                          <div class="form-group">
                            <a class=" btn btn-primary btn-lg" id="end_tally_btn" href="javascript:endTally()">End Tally</a>
                          </div>
                        </div>                         
                        </div>
                    
                        <table style="font-size: 30px;" id="classTable" class="display" cellspacing="0" data-toolbar="#toolbar" data-query-params="queryParams" data-pagination="false"
                        data-show-pagination-switch="true" data-editable="true" data-striped="true" data-search="true" data-show-multi-sort="true" >
                            
                        </table>
                </div>
            </div>

            <!-- Bootstrap modal -->
            <div class="modal fade" id="modal_form" role="dialog">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                            <h3 class="modal-title">Tally Detail Form</h3>
                        </div>
                        <div class="modal-body form">
                            <form id="edit_form" class="form-horizontal" data-toggle="validator">
                                <input type="hidden" value="" name="id" id="id" />
                                <div class="form-body"> 
 <div class="form-group hidden">  <label class="control-label col-md-3">Tally Id</label><div class="col-md-9"> <input id="tally_id" name="tally_id" placeholder="Tally Id" class="form-control" type="text" required><span class="help-block"></span> </div> </div>
 <div class="form-group hidden">  <label class="control-label col-md-3">Billoflading Detail Id</label><div class="col-md-9"> <input id="billoflading_detail_id" name="billoflading_detail_id" placeholder="Billoflading Detail Id" class="form-control" type="text" ><span class="help-block"></span> </div> </div>
 <div class="form-group">  <label class="control-label col-md-3">Reference Number</label><div class="col-md-9"> <input id="bill_of_lading_number" name="bill_of_lading_number" placeholder="Bill Of Lading Number" class="form-control" type="text" required><span class="help-block"></span> </div> </div>
 <div class="form-group hidden">  <label class="control-label col-md-3">Consignee Name</label><div class="col-md-9"> <input id="consignee_name" name="consignee_name" placeholder="Consignee Name" class="form-control" type="text" hidden><span class="help-block"></span> </div> </div>
 <div class="form-group">  <label class="control-label col-md-3">Package Type </label><div class="col-md-9"> <select id="package_type_id"  class=" load-select form-control" data-path="./app/package" required></select><span class="help-block"></span> </div> </div>
 <div class="form-group">  <label class="control-label col-md-3">Number Of Items</label><div class="col-md-9"> <input id="number_of_items" name="number_of_items" placeholder="Number Of Items" class="form-control" type="number" required><span class="help-block"></span> </div> </div></div><div class="modal-footer">
                                    <input id="submit" type="submit" class="btn btn-info" value="Save" onclick="saveRecord()">
                                    <button type="button" class="btn btn-danger" data-dismiss="modal">Cancel</button>
                                </div>
                            </form>
                        </div>

                    </div>
                    <!-- /.modal-content -->
                </div>
                <!-- /.modal-dialog -->
            </div>
            <!-- /.modal -->
            <!-- End Bootstrap modal -->
            <!-- /page content -->

            <!-- footer content -->
            <footer>
                <div class="pull-right">
                    Gentelella - Bootstrap Admin Template by
                    <a href="https://colorlib.com">Colorlib</a>
                </div>
                <div class="clearfix"></div>
            </footer>
            <!-- /footer content -->
        </div>
    </div>
   
    <script src="./vendor/js/jquery.min.js"></script>
    <script src="./vendor/js/jquery-ui.js"></script>
    <script src="./vendor/js/bootstrap.min.js"></script>
    <script src="./vendor/js/bootstrap-table.min.js"></script>
    <script src="./vendor/js/bootstrap-select.min.js"></script>
    <script src="./js/ajax-bootstrap-select.min.js"></script>
    <script src="./vendors/fastclick/lib/fastclick.js"></script>
    <!-- NProgress -->
    <script src="./vendors/nprogress/nprogress.js"></script>

    <script src="./js/bootstrap-editable.js"></script>
    <!-- iCheck -->
    <script src="./js/bootstrap-table-editable.js"></script>
    <script src="./vendors/iCheck/icheck.min.js"></script>
    <!-- bootstrap-daterangepicker -->
    <script src="./js/datepicker.min.js"></script>

    <script type="text/javascript" src="./dist/js/bootstrapValidator.js"></script>
    <script type="text/javascript" src="./vendor/js/toastr.min.js"></script>

    <!-- Custom Theme Scripts -->
    <script src="./build/js/custom.min.js"></script>

    <script src="./scripts/app.js"></script>
    <script src="./scripts/crud.js"></script>

    <script>

        $(document).ready(function () {
            //
 data_model={ "id": "0","tally_id": "","billoflading_detail_id": "","bill_of_lading_number": "","consignee_name": "","package_type_id": "","number_of_items": ""};
            //
 businessObject=   new BusinessObject(data_model,'tally_detail'); 
            fieldValidatrs={};
            //
 fieldValidatrs.tally_id=createValidationField('Tally Id','notEmpty');
  fieldValidatrs.bill_of_lading_number=createValidationField('Bill Of Lading Number','notEmpty');
  fieldValidatrs.package_type_id=createValidationField('Package Type Id','notEmpty');
 fieldValidatrs.number_of_items=createValidationField('Number Of Items','notEmpty');
            crudInit(businessObject);
            loadBusinessObjects(businessObject.data_table);
            businessObject.beforeNewRecord=function(){
                $("#tally_id").val(TALLY_OBJ.id);
            }
            businessObject.afterSave=function(){
                startTally(businessObject.data_model.id);
            }
            loadBookingSelect();
        });        

       
 function loadBookingSelect() {
      $('#booking').empty();
      var select_path = './app/booking/tally';
      if (SELECT_DATA_PATH[select_path]) {
        $.each(SELECT_DATA_PATH[select_path], function (key, value) {
          $('#booking').append('<option value=' + value.id + '>' + value.manifest_number + ' - ' + formatDate(value.sail_date) + '</option>');
        });
        loadTallyTable();
      } else {
        $.ajax({
          url: select_path,
          type: 'GET',
          dataType: 'json',
          async: false,
          success: function (data) {
            SELECT_DATA_PATH[select_path] = data;
            $.each(data, function (key, value) {
              $('#booking').append('<option value=' + value.id + '>' + value.manifest_number + ' - ' + formatDate(value.sail_date) + '</option>');
            });
            loadTallyTable();
          },
          error: function (xhr, ajaxOptions, thrownError) { handleStandardHttpErrors(xhr, ajaxOptions, thrownError) },
          beforeSend: function (xhr, settings) { xhr.setRequestHeader('Authorization', 'Bearer ' + token); }
        });
      }
      loadBookingContainerSelect();
    }
    function loadBookingContainerSelect() {
      $('#booking_container').empty();
      var select_path = './app/booking_container/select/' + $('#booking').val();
      if (SELECT_DATA_PATH[select_path]) {
        $.each(SELECT_DATA_PATH[select_path], function (key, value) {
          $('#booking_container').append('<option value=' + value.id + '>' + value.container_number  + '</option>');
          console.log(value.container_number);
        });
      } else {
        $.ajax({
          url: select_path,
          type: 'GET',
          dataType: 'json',
          async: false,
          success: function (data) {
            console.log(data);
            SELECT_DATA_PATH[select_path] = data;
            $.each(data, function (key, value) {
              $('#booking_container').append('<option value=' + value.id + '>' + value.container_number  + '</option>');
        
            });            
          },
          error: function (xhr, ajaxOptions, thrownError) { handleStandardHttpErrors(xhr, ajaxOptions, thrownError) },
          beforeSend: function (xhr, settings) { xhr.setRequestHeader('Authorization', 'Bearer ' + token); }
        });
      }
      updateStatus();
    }
    function loadTallyTable(){
        var obj=getBusinessObject('tally/booking',numeric($('#booking').val()));      
        if(obj.length>0)    { TALLY_OBJ=obj[0]; }
        loadBookingContainerSelect();
        loadBusinessObjects();

    }
    TALLY_OBJ={};
    function updateStatus(){     
      
      $("#vessel_name").html("");
      var select_path = './app/booking/tally' ;
      if (SELECT_DATA_PATH[select_path]) {
        $.each(SELECT_DATA_PATH[select_path], function (key, value) {
          if($('#booking').val()==value.id){
              $("#vessel_name").html(value.vessel_name);
          }          
        });

        $("#tally_status").html("Not Started");
        $("#tally_quantity").html("");
        $("#tally_start").html("");
        if(!TALLY_OBJ.start_date){
            var obj=getBusinessObject('tally/booking',numeric($('#booking').val()));      
            if(obj.length>0)    { TALLY_OBJ=obj[0]; }
            else {
                TALLY_OBJ={start_date:0,status:'Not Started',end_date:0};
            }
        }
        $("#tally_status").html(TALLY_OBJ.status);
        $("#tally_start").html(formatDate(numeric(TALLY_OBJ.start_date)));
        console.log(TALLY_OBJ);
        if(TALLY_OBJ.end_date==0){   $("#end_tally_btn").show(); }
        else {$("#end_tally_btn").hide();}
            //update quantity
            var amt=0;            
            var rows= $('#classTable').bootstrapTable('getData');
            $.each(rows,function(ind,value){
                amt +=numeric(value.number_of_items);
            });
            $("#tally_quantity").html(amt);
      }
      console.log(TALLY_OBJ);
    }

    function  loadBusinessObjects(){
        var package_types= loadPackageTypes();
        $.fn.editable.defaults.mode = 'inline';
        $('#classTable').bootstrapTable("destroy");
        $.ajax({
            url: './app/tally_detail/create_list/'+$("#booking").val(),
            type: 'GET',
            dataType: 'json',
            success: function (data) {
                $('#classTable').bootstrapTable({
                    idField: 'id',
                    uniqueId: 'id',
                   // height: 550,
                    columns:[
                            {
                                field: 'tally_id',
                                sortable: true,
                                align: 'left',
                                title: 'id',
                                visible:false
                            },
                            {
                                field: 'bill_of_lading_number',
                                sortable: true,   
                                title: 'Reference',                                  
                                align: 'left',
                                editable: {
                                    type: 'text',
                                    onblur: 'submit',
                                    validate: function (value) {
                                        value = $.trim(value);
                                        if (!value) {
                                        return 'This field is required';
                                        }
                                    },
                                    url: function (params) {
                                        var obj = {};
                                        obj[params.name] = params.value;
                                        return saveTallyRecord(obj, params.pk);
                                    }

                                    }  
                            },
                            {
                                field: 'package_type_id',
                                title: 'Package Type',
                                sortable: true,
                                editable: {
                                type: 'select',
                                onblur: 'submit',
                                source: package_types,
                                url: function (params) {
                                    console.log(params);
                                    var obj = {};
                                    obj[params.name] = params.value;
                                    return saveTallyRecord(obj, params.pk);
                                }
                                }
                            },
                            {
                                field: 'number_of_items',
                                sortable: true,       
                                align: 'left',
                                title: 'No. of Items',
                                editable: {
                                    type: 'number',  
                                    onblur: 'submit',                                  
                                    url: function (params) {
                                        var obj = {};
                                        obj[params.name] = params.value;
                                        return saveTallyRecord(obj, params.pk);
                                    }

                                    }
                            }
                            , {
                                field: 'operate',
                                title: ' ',
                                align: 'center',
                                formatter: operateFormatter
                            }
                        ],
                    data: data
                });

              updateStatus();
            },
            error: function (xhr, ajaxOptions, thrownError) {
                handleStandardHttpErrors(xhr, ajaxOptions, thrownError);
            },
            beforeSend: function (xhr, settings) { xhr.setRequestHeader('Authorization', 'Bearer ' + token); }
        });
    }
    function operateFormatter(value, row, index) {
        var txt=['<a class="btn-danger" onclick="deleteThis(' + row.id + ')" href="#" title="Remove">',
        '<i class="glyphicon glyphicon-remove"></i>','</a>'
      ].join('');      
      if(numeric(row.billoflading_detail_id) !=0 && (row.bl_num == row.bill_of_lading_number)) txt='';
      return txt;
    }
  
    function loadPackageTypes() {
            var select_path = './app/package/select';
            var package_code = [], obj = {};
            if (SELECT_DATA_PATH[select_path]) {
                $.each(SELECT_DATA_PATH[select_path], function (key, value) {
                    obj = {};
                    obj['value'] = value.id;
                    obj['text'] = value.description;
                    package_code.push(obj);
                });
            } else {
                $.ajax({
                    url: select_path,
                    type: 'GET',
                    dataType: 'json',
                    async: false,
                    success: function (data) {
                        SELECT_DATA_PATH[select_path] = data;
                        $.each(data, function (key, value) {
                            obj = {};
                            obj['value'] = value.id;
                            obj['text'] = value.description;
                            package_code.push(obj);
                        });
                    },
                    error: function (xhr, ajaxOptions, thrownError) { handleStandardHttpErrors(xhr, ajaxOptions, thrownError) },
                    beforeSend: function (xhr, settings) { xhr.setRequestHeader('Authorization', 'Bearer ' + token); }
                });
            }
            return package_code;
        }
        function saveTallyRecord(field_obj, id) {
        console.log('are we getting here');
        var record_saved = false;
        $.ajax({
            type: "PUT",
            url: './app/tally_detail/' + id,
            data: JSON.stringify(field_obj),
            success: function (data) {
            record_saved = true;
            startTally(id); 
            },
            error: function (xhr, ajaxOptions, thrownError) { handleStandardHttpErrors(xhr, ajaxOptions, thrownError) },
            beforeSend: function (xhr, settings) { xhr.setRequestHeader('Authorization', 'Bearer ' + token); }
        });
        return record_saved;
        }

        function startTally(id){                           
                var row=getRowWithId(id);
                if(row){
                    var obj={id:row.tally_id,end_date:0,end_time:0,status:'In Progress'};                                        
                    if (TALLY_OBJ.start_date==0){ 
                        var d = new Date();
                        obj.start_date=''+d.getFullYear()+pad((1 + d.getMonth()), 2)+pad(d.getDate(), 2);
                        obj.start_time=''+pad(d.getHours(),2) + pad(d.getMinutes(),2) + pad(d.getSeconds(),2);
                    }                    
                    updateDataModel(obj,'tally');
                }
                TALLY_OBJ.status='In Progress';
                TALLY_OBJ.end_date=0;
                TALLY_OBJ.end_time=0;
            updateStatus();
            //updateBusinessObject(form_data,data_table)  
        }
        function getRowWithId(id) {
            var tab = $('#classTable');
            var obj = {};            
            var rows= tab.bootstrapTable('getData');
            console.log(rows);
            $.each(rows,function(ind,value){
                if(id==value.id){
                  obj=value;
                }
            });
            return obj;
      }
      function endTally(){
            var d = new Date();
            var date=''+d.getFullYear()+pad((1 + d.getMonth()), 2)+pad(d.getDate(), 2);
            var time=''+pad(d.getHours(),2) + pad(d.getMinutes(),2) + pad(d.getSeconds(),2);
            var obj={end_date:date,id:TALLY_OBJ.id,end_time:time,status:'Tally Ended'};                                        
            updateDataModel(obj,'tally');
            $("#end_tally_btn").hide();
            TALLY_OBJ.end_date=date;
            TALLY_OBJ.end_time=time;
            TALLY_OBJ.status='Tally Ended';
            updateStatus();
      }
    </script>
</body>

</html>